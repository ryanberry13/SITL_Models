<?xml version="1.0" ?>
<sdf version="1.7">
  <world name="propeller_test_stand">
    <plugin filename="libignition-gazebo-physics-system.so"
      name="ignition::gazebo::systems::Physics">
    </plugin>
    <plugin
      filename="ignition-gazebo-sensors-system"
      name="ignition::gazebo::systems::Sensors">
      <render_engine>ogre2</render_engine>
    </plugin>
    <plugin filename="libignition-gazebo-user-commands-system.so"
      name="ignition::gazebo::systems::UserCommands">
    </plugin>
    <plugin filename="libignition-gazebo-scene-broadcaster-system.so"
      name="ignition::gazebo::systems::SceneBroadcaster">
    </plugin>
    <plugin
      filename="ignition-gazebo-air-pressure-system"
      name="ignition::gazebo::systems::AirPressure">
    </plugin>
    <plugin
      filename="ignition-gazebo-altimeter-system"
      name="ignition::gazebo::systems::Altimeter">
    </plugin>
    <plugin
      filename="ignition-gazebo-imu-system"
      name="ignition::gazebo::systems::Imu">
    </plugin>
    <plugin
      filename="ignition-gazebo-magnetometer-system"
      name="ignition::gazebo::systems::Magnetometer">
    </plugin>
    <plugin filename="ignition-gazebo-forcetorque-system"
      name="ignition::gazebo::systems::ForceTorque" />

    <scene>
      <ambient>1.0 1.0 1.0</ambient>
      <background>0.8 0.8 0.8</background>
      <sky></sky>
    </scene>

    <light type="directional" name="sun">
      <cast_shadows>true</cast_shadows>
      <pose>0 0 10 0 0 0</pose>
      <diffuse>0.8 0.8 0.8 1</diffuse>
      <specular>0.8 0.8 0.8 1</specular>
      <attenuation>
        <range>1000</range>
        <constant>0.9</constant>
        <linear>0.01</linear>
        <quadratic>0.001</quadratic>
      </attenuation>
      <direction>-0.5 0.1 -0.9</direction>
    </light>

    <include>
      <uri>https://fuel.ignitionrobotics.org/1.0/OpenRobotics/models/Ground Plane</uri>
    </include>

    <!-- Propeller Test Stand -->
    <model name="test_stand">
      <pose>0 0 0.03 0 0 0</pose>
      <link name="base_link">
        <inertial>
          <pose>0 0 0 0 0 0</pose>
          <mass>1000</mass>
          <inertia>
            <ixx>10</ixx>
            <ixy>0</ixy>
            <ixz>0</ixz>
            <iyy>10</iyy>
            <iyz>0</iyz>
            <izz>10</izz>
          </inertia>
        </inertial>
        <collision name="collision">
          <geometry>
            <box>
              <size>0.2 0.2 0.05</size>
            </box>
          </geometry>
        </collision>
        <visual name="visual">
          <geometry>
            <box>
              <size>0.2 0.2 0.05</size>
            </box>
          </geometry>
          <material>
            <ambient>0.2 0.2 0.2</ambient>
            <diffuse>0.2 0.2 0.2</diffuse>
            <specular>0.1 0.1 0.1</specular>
          </material>
        </visual>
      </link>

      <link name='motor_link'>
        <pose relative_to='motor_joint'>0 0 0.018 0 0 0</pose>
        <inertial>
          <pose>0 0 -0.018 0 0 0</pose>
          <mass>0.025</mass>
          <inertia>
            <ixx>9.75e-06</ixx>
            <ixy>0</ixy>
            <ixz>0</ixz>
            <iyy>0.000166704</iyy>
            <iyz>0</iyz>
            <izz>0.000167604</izz>
          </inertia>
        </inertial>
        <collision name='collision'>
          <pose>0 0 0 0 0 0</pose>
          <geometry>
            <cylinder>
              <length>0.002</length>
              <radius>0.05</radius>
            </cylinder>
          </geometry>
        </collision>
        <visual name='spinner_visual'>
          <pose>0 0 -0.01 0 0 0</pose>
          <geometry>
            <mesh>
              <scale>1 1 1</scale>
              <uri>model://omnicopter/meshes/spinner.dae</uri>
            </mesh>
          </geometry>
          <material>
            <ambient>1 1 1</ambient>
            <diffuse>1 1 1</diffuse>
            <specular>1 1 1</specular>
            <pbr>
              <metal>
                <albedo_map>model://omnicopter/materials/textures/red_metal/red_metal_diffuse.jpg</albedo_map>
                <metalness_map>model://omnicopter/materials/textures/red_metal/red_metal_metallic.jpg</metalness_map>
                <normal_map>model://omnicopter/materials/textures/red_metal/red_metal_normal.jpg</normal_map>
                <roughness_map>model://omnicopter/materials/textures/red_metal/red_metal_roughness.jpg</roughness_map>
                <roughness>1.0</roughness>
                <metalness>1.0</metalness> 
              </metal>
            </pbr>
          </material>
        </visual>
        <visual name='prop_visual'>
          <pose>0 0 0 0 0 0</pose>
          <geometry>
            <mesh>
              <scale>0.5 0.5 0.5</scale>
              <uri>model://omnicopter/meshes/iris_prop_cw.dae</uri>
            </mesh>
          </geometry>
          <material>
            <ambient>1 1 1</ambient>
            <diffuse>1 1 1</diffuse>
            <specular>0.3 0.3 0.3</specular>
            <pbr>
              <metal>
                <albedo_map>model://omnicopter/materials/textures/plastic008/plastic008_1k_diffuse.jpg</albedo_map>
                <normal_map>model://omnicopter/materials/textures/plastic008/plastic008_1k_normal.jpg</normal_map>
                <roughness_map>model://omnicopter/materials/textures/plastic008/plastic008_1k_roughness.jpg</roughness_map>
                <roughness>0.5</roughness>
                <metalness>0.5</metalness> 
              </metal>
            </pbr>
          </material>
        </visual>
        <!-- <visual name='prop_disk_visual'>
          <pose>0 0 0 0 0 0</pose>
          <geometry>
            <cylinder>
              <length>0.002</length>
              <radius>0.05</radius>
            </cylinder>
          </geometry>
          <material>
            <ambient>1 1 0 0.5</ambient>
            <diffuse>1 1 0 0.5</diffuse>
            <specular>0.3 0.3 0.3 0.5</specular>
          </material>
        </visual> -->
      </link>
      <joint name='motor_joint' type='revolute'>
        <pose relative_to='base_link'>0 0 0.03 0 0 0</pose>
        <parent>base_link</parent>
        <child>motor_link</child>
        <axis>
          <xyz>0 0 1</xyz>
          <limit>
            <lower>-1e16</lower>
            <upper>1e16</upper>
          </limit>
          <dynamics>
            <damping>0.003</damping>
          </dynamics>
        </axis>
        <sensor name="force_torque_sensor" type="force_torque">
          <update_rate>30</update_rate>
          <always_on>true</always_on>
          <visualize>true</visualize>
          <force_torque>
            <frame>sensor</frame>
            <measure_direction>child_to_parent</measure_direction>
          </force_torque>
        </sensor>
      </joint>

      <!-- sensors -->
      <link name='imu_link'>
        <inertial>
          <pose>0 0 0 0 0 0</pose>
          <mass>0.15</mass>
          <inertia>
            <ixx>0.00002</ixx>
            <ixy>0</ixy>
            <ixz>0</ixz>
            <iyy>0.00002</iyy>
            <iyz>0</iyz>
            <izz>0.00002</izz>
          </inertia>
        </inertial>
        <sensor name="imu_sensor" type="imu">
          <pose>0 0 0 3.141593 0 0</pose>
          <always_on>1</always_on>
          <update_rate>1000.0</update_rate>
        </sensor>
      </link>
      <joint name='imu_joint' type='revolute'>
        <child>imu_link</child>
        <parent>base_link</parent>
        <axis>
          <xyz>0 0 1</xyz>
          <limit>
            <lower>0</lower>
            <upper>0</upper>
            <effort>0</effort>
            <velocity>0</velocity>
          </limit>
          <dynamics>
            <damping>1.0</damping>
          </dynamics>
          <use_parent_model_frame>1</use_parent_model_frame>
        </axis>
      </joint>

      <!-- plugins -->
      <plugin filename="libignition-gazebo-joint-state-publisher-system.so"
        name="ignition::gazebo::systems::JointStatePublisher">
      </plugin>
      <plugin filename="libignition-gazebo-apply-joint-force-system.so"
        name="ignition::gazebo::systems::ApplyJointForce">
        <joint_name>motor_joint</joint_name>
      </plugin>

      <!-- prop motor_1 (cw) lift-drag -->
      <plugin filename="libignition-gazebo-lift-drag-system.so"
          name="ignition::gazebo::systems::LiftDrag">
        <a0>0.3</a0>
        <alpha_stall>1</alpha_stall>
        <cla>4.25</cla>
        <cda>0.10</cda>
        <cma>0.00</cma>
        <cla_stall>-4.25</cla_stall>
        <cda_stall>0.0</cda_stall>
        <cma_stall>0.0</cma_stall>
        <area>0.003</area>
        <air_density>1.2041</air_density>
        <cp>0.05 0 0</cp>
        <forward>0 -1 0</forward>
        <upward>0 0 1</upward>
        <link_name>motor_link</link_name>
        <element_name>blade_1</element_name>
      </plugin>
      <plugin filename="libignition-gazebo-lift-drag-system.so"
          name="ignition::gazebo::systems::LiftDrag">
        <a0>0.3</a0>
        <alpha_stall>1</alpha_stall>
        <cla>4.25</cla>
        <cda>0.10</cda>
        <cma>0.00</cma>
        <cla_stall>-4.25</cla_stall>
        <cda_stall>0.0</cda_stall>
        <cma_stall>0.0</cma_stall>
        <area>0.003</area>
        <air_density>1.2041</air_density>
        <cp>-0.05 0 0</cp>
        <forward>0 1 0</forward>
        <upward>0 0 1</upward>
        <link_name>motor_link</link_name>
        <element_name>blade_2</element_name>
      </plugin>

      <plugin name="ArduPilotPlugin" filename="libArduPilotPlugin.so">
        <fdm_addr>127.0.0.1</fdm_addr>
        <fdm_port_in>9002</fdm_port_in>
        <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
        <lock_step>1</lock_step>
        <modelXYZToAirplaneXForwardZDown>0 0 0 3.141593 0 0</modelXYZToAirplaneXForwardZDown>
        <gazeboXYZToNED>0 0 0 3.141593 0 0</gazeboXYZToNED>
        <imuName>imu_sensor</imuName>

        <!-- 
            SERVO1_FUNCTION   33 (Motor 1 CW)
            SERVO1_MAX        2000
            SERVO1_MIN        1000
            SERVO1_REVERSED   0
            SERVO1_TRIM       1500
        -->
        <control channel="0">
          <jointName>motor_joint</jointName>
          <useForce>1</useForce>
          <multiplier>-2762</multiplier>
          <offset>0</offset>
          <servo_min>1100</servo_min>
          <servo_max>1900</servo_max>
          <type>VELOCITY</type>
          <p_gain>0.1</p_gain> 
          <i_gain>0.01</i_gain>
          <d_gain>0</d_gain>
          <i_max>0.1</i_max>
          <i_min>-0.1</i_min>
          <cmd_max>5.0</cmd_max>
          <cmd_min>-5.0</cmd_min>
          <!-- <type>FORCE</type>
          <multiplier>30</multiplier>
          <motor_spin>-1</motor_spin>
          <motor_k_tau>0.01085</motor_k_tau> -->
        </control>
      </plugin>

    </model>

  </world>
</sdf>
